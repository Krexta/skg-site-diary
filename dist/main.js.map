{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\n\nimport {\n  BadRequestException,\n  INestApplication,\n  Logger,\n  ValidationError,\n  ValidationPipe,\n} from '@nestjs/common';\nimport { NestFactory } from '@nestjs/core';\nimport { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';\nimport * as yaml from 'js-yaml';\n\nimport { AppModule } from './module/app.module';\nimport { AppConfig, CustomLogger } from './utility';\n\nfunction swaggerSetup(app: INestApplication) {\n  const logger = new Logger('swagger');\n\n  const config = new DocumentBuilder()\n    .setTitle('SKG Site Diary API')\n    .setDescription('SKG 現場記録API')\n    .setVersion('0.1.0')\n    .addBearerAuth()\n    .build();\n  const document = SwaggerModule.createDocument(app, config);\n\n  fs.writeFileSync(\n    path.resolve(process.cwd(), 'doc/openapi/openapi.yaml'),\n    yaml.dump(document, {\n      skipInvalid: true,\n      noRefs: true,\n    }),\n  );\n  const endpoint = 'api';\n  SwaggerModule.setup(endpoint, app, document);\n\n  logger.warn(`Swagger UI is available on /${endpoint}`);\n}\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule, {\n    bufferLogs: true,\n    logger: AppConfig.LoggingLogLevel(),\n  });\n  const configService = app.get(AppConfig);\n  app.useLogger(app.get(CustomLogger));\n\n  app.useGlobalPipes(\n    new ValidationPipe({\n      disableErrorMessages: configService.isValidationDisableErrorMessage,\n      transform: true,\n      exceptionFactory: (validationErrors: ValidationError[] = []) => {\n        return new BadRequestException(\n          validationErrors.map((error) => {\n            if (\n              error.children &&\n              error.children[0] &&\n              error.children[0].children\n            ) {\n              return Object.values(\n                error.children[0].children[0].constraints ?? {},\n              )[0];\n            }\n            return Object.values(error.constraints ?? {})[0];\n          }),\n        );\n      },\n    }),\n  );\n\n  const logger = new Logger('bootstrap');\n\n  configService.switchSwaggerSetup(() => swaggerSetup(app));\n\n  await app.listen(configService.port);\n  logger.debug(`Server running on port: ${new URL(await app.getUrl()).port}`);\n}\nbootstrap();\n"],"names":["fs","path","BadRequestException","Logger","ValidationPipe","NestFactory","DocumentBuilder","SwaggerModule","yaml","AppModule","AppConfig","CustomLogger","swaggerSetup","app","logger","config","setTitle","setDescription","setVersion","addBearerAuth","build","document","createDocument","writeFileSync","resolve","process","cwd","dump","skipInvalid","noRefs","endpoint","setup","warn","bootstrap","create","bufferLogs","LoggingLogLevel","configService","get","useLogger","useGlobalPipes","disableErrorMessages","isValidationDisableErrorMessage","transform","exceptionFactory","validationErrors","map","error","children","Object","values","constraints","switchSwaggerSetup","listen","port","debug","URL","getUrl"],"mappings":"AAAA,YAAYA,QAAQ,KAAK;AACzB,YAAYC,UAAU,OAAO;AAE7B,SACEC,mBAAmB,EAEnBC,MAAM,EAENC,cAAc,QACT,iBAAiB;AACxB,SAASC,WAAW,QAAQ,eAAe;AAC3C,SAASC,eAAe,EAAEC,aAAa,QAAQ,kBAAkB;AACjE,YAAYC,UAAU,UAAU;AAEhC,SAASC,SAAS,QAAQ,yBAAsB;AAChD,SAASC,SAAS,EAAEC,YAAY,QAAQ,qBAAY;AAEpD,SAASC,aAAaC,GAAqB;IACzC,MAAMC,SAAS,IAAIX,OAAO;IAE1B,MAAMY,SAAS,IAAIT,kBAChBU,QAAQ,CAAC,sBACTC,cAAc,CAAC,eACfC,UAAU,CAAC,SACXC,aAAa,GACbC,KAAK;IACR,MAAMC,WAAWd,cAAce,cAAc,CAACT,KAAKE;IAEnDf,GAAGuB,aAAa,CACdtB,KAAKuB,OAAO,CAACC,QAAQC,GAAG,IAAI,6BAC5BlB,KAAKmB,IAAI,CAACN,UAAU;QAClBO,aAAa;QACbC,QAAQ;IACV;IAEF,MAAMC,WAAW;IACjBvB,cAAcwB,KAAK,CAACD,UAAUjB,KAAKQ;IAEnCP,OAAOkB,IAAI,CAAC,CAAC,4BAA4B,EAAEF,UAAU;AACvD;AAEA,eAAeG;IACb,MAAMpB,MAAM,MAAMR,YAAY6B,MAAM,CAACzB,WAAW;QAC9C0B,YAAY;QACZrB,QAAQJ,UAAU0B,eAAe;IACnC;IACA,MAAMC,gBAAgBxB,IAAIyB,GAAG,CAAC5B;IAC9BG,IAAI0B,SAAS,CAAC1B,IAAIyB,GAAG,CAAC3B;IAEtBE,IAAI2B,cAAc,CAChB,IAAIpC,eAAe;QACjBqC,sBAAsBJ,cAAcK,+BAA+B;QACnEC,WAAW;QACXC,kBAAkB,CAACC,mBAAsC,EAAE;YACzD,OAAO,IAAI3C,oBACT2C,iBAAiBC,GAAG,CAAC,CAACC;gBACpB,IACEA,MAAMC,QAAQ,IACdD,MAAMC,QAAQ,CAAC,EAAE,IACjBD,MAAMC,QAAQ,CAAC,EAAE,CAACA,QAAQ,EAC1B;oBACA,OAAOC,OAAOC,MAAM,CAClBH,MAAMC,QAAQ,CAAC,EAAE,CAACA,QAAQ,CAAC,EAAE,CAACG,WAAW,IAAI,CAAC,EAC/C,CAAC,EAAE;gBACN;gBACA,OAAOF,OAAOC,MAAM,CAACH,MAAMI,WAAW,IAAI,CAAC,EAAE,CAAC,EAAE;YAClD;QAEJ;IACF;IAGF,MAAMrC,SAAS,IAAIX,OAAO;IAE1BkC,cAAce,kBAAkB,CAAC,IAAMxC,aAAaC;IAEpD,MAAMA,IAAIwC,MAAM,CAAChB,cAAciB,IAAI;IACnCxC,OAAOyC,KAAK,CAAC,CAAC,wBAAwB,EAAE,IAAIC,IAAI,MAAM3C,IAAI4C,MAAM,IAAIH,IAAI,EAAE;AAC5E;AACArB"}